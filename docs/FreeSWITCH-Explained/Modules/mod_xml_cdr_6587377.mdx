# mod_xml_cdr

## 关于

将CDR记录以XML格式输出到本地文件或通过HTTP POST方式发送到Web服务器。

单击此处展开目录

* 1 [示例](#fs-xml-cdrpl)
* 2 [特点](#features)  
   * 2.1 [输出能力](#output-capabilities)  
   * 2.2 [可靠性能力](#reliability-capabilities)
* 3 [使其工作](#getting-it-working)  
   * 3.1 [modules.conf](#modulesconf)  
   * 3.2 [安装依赖项](#install-dependencies)  
   * 3.3 [示例配置](#sample-configuration)  
      * 3.3.1 [验证](#verifying)  
   * 3.4 [配置选项](#configuration-options)  
   * 3.5 [处理POST请求](#handling-post-request)  
      * 3.5.1 [示例](#fs-xml-cdrpl)  
   * 3.6 [重新提交失败的CDR提交](#resubmitting-failed-cdr-submissions)  
      * 3.6.1 [脚本（用于cronjob或手动运行）](#script-for-cronjob-or-manual-run)  
   * 3.7 [参考信息](#reference-information)  
      * 3.7.1 [通道变量](#channel-variables)  
   * 3.8 [故障排除](#troubleshooting)  
      * 3.8.1 [加载模块时出错](#error-loading-module)  
         * 3.8.2 [不写入非默认的logDir](#does-not-write-to-non-default-logdir)  
         * 3.8.3 [当模块加载时出现内存错误](#im-getting-a-memory-error-when-module-loads)  
   * 3.9 [示例CGI脚本](#example-cgi-script)  
      * 3.9.1 [代码清单 \[Perl\]](#code-listing-perl)  
   * 3.10 [常见问题](#fs-xml-cdrpl)  
      * 3.10.1 [问：是否需要编译/启用mod_cdr?](#q-does-mod_cdr-need-to-be-compiledenabled)

## 示例

以下是一个示例XML CDR： 

示例XML CDR

```xml
<?xml version="1.0"?>
<cdr>
  <variables>
    <sip_received_ip>192.168.50.21</sip_received_ip>
    <sip_received_port>39368</sip_received_port>
    <sip_authorized>true</sip_authorized>
    <sip_mailbox>1160</sip_mailbox>
    <sip_auth_username>1160</sip_auth_username>

    <sip_auth_realm>192.168.50.229</sip_auth_realm>
    <mailbox>1160</mailbox>
    <record_stereo>true</record_stereo>
    <accountcode>1160</accountcode>
    <user_context>default</user_context>
    <effective_caller_id_name>Michael%20S%20Collins</effective_caller_id_name>

    <effective_caller_id_number>5597993757</effective_caller_id_number>
    <sip_from_user>1160</sip_from_user>
    <sip_from_uri>1160%40192.168.50.229</sip_from_uri>
    <sip_from_host>192.168.50.229</sip_from_host>
    <sip_from_user_stripped>1160</sip_from_user_stripped>
    <sip_from_tag>a360bd54</sip_from_tag>

    <sofia_profile_name>internal</sofia_profile_name>
    <sofia_profile_domain_name>192.168.50.229</sofia_profile_domain_name>
    <sip_req_user>92137991400</sip_req_user>
    <sip_req_uri>92137991400%40192.168.50.229</sip_req_uri>
    <sip_req_host>192.168.50.229</sip_req_host>
    <sip_to_user>92137991400</sip_to_user>

    <sip_to_uri>92137991400%40192.168.50.229</sip_to_uri>
    <sip_to_host>192.168.50.229</sip_to_host>
    <sip_contact_user>1160</sip_contact_user>
    <sip_contact_port>39368</sip_contact_port>
    <sip_contact_uri>1160%40192.168.50.21%3A39368</sip_contact_uri>
    <sip_contact_host>192.168.50.21</sip_contact_host>
```

&lt;channel_name>sofia/internal/1160%40192.168.50.229&lt;/channel_name>
    &lt;sip_call_id>NzUyYzU2ZmU0NjQ0NmNkMGExYTNiZjIzMjIwMWNiODc.&lt;/sip_call_id>
    &lt;sip_via_host>192.168.50.21&lt;/sip_via_host>
    &lt;sip_via_port>39368&lt;/sip_via_port>
    &lt;sip_via_rport>39368&lt;/sip_via_rport>
    &lt;max_forwards>70&lt;/max_forwards>

    &lt;presence_id>1160%40192.168.50.229&lt;/presence_id>
    &lt;switch_r_sdp>v%3D0%0D%0Ao%3D-%206%202%20IN%20IP4%20192.168.50.21%0D%0As%3DCounterPath%20X-Lite%203.0%0D%0Ac%3DIN%20IP4%20192.168.50.21%0D%0At%3D0%200%0D%0Am%3Daudio%209140%20RTP/AVP%20107%20119%20100%20106%200%20105%2098%208%203%20101%0D%0Aa%3Drtpmap%3A107%20BV32/16000%0D%0Aa%3Drtpmap%3A119%20BV32-FEC/16000%0D%0Aa%3Drtpmap%3A100%20SPEEX/16000%0D%0Aa%3Drtpmap%3A106%20SPEEX-FEC/16000%0D%0Aa%3Drtpmap%3A105%20SPEEX-FEC/8000%0D%0Aa%3Drtpmap%3A98%20iLBC/8000%0D%0Aa%3Drtpmap%3A101%20telephone-event/8000%0D%0Aa%3Dfmtp%3A101%200-15%0D%0Aa%3Dalt%3A1%201%20%3A%20CV3qZAA1%209gFf2/Iz%20192.168.50.21%209140%0D%0A&lt;/switch_r_sdp>
    &lt;remote_media_ip>192.168.50.21&lt;/remote_media_ip>
    &lt;remote_media_port>9140&lt;/remote_media_port>
    &lt;write_codec>PCMU&lt;/write_codec>
    &lt;write_rate>8000&lt;/write_rate>

    &lt;open>true&lt;/open>
    &lt;use_profile>nat&lt;/use_profile>
    &lt;numbering_plan>US&lt;/numbering_plan>
    &lt;default_gateway>asterlink.com&lt;/default_gateway>
    &lt;default_area_code>559&lt;/default_area_code>
    &lt;user_name>default&lt;/user_name>

**&lt;domain_name>192.168.50.229&lt;/domain_name>**
&lt;domain_name>192.168.50.229&lt;/domain_name>

**&lt;local_media_ip>192.168.50.229&lt;/local_media_ip>**
&lt;local_media_ip>192.168.50.229&lt;/local_media_ip>

**&lt;local_media_port>9140&lt;/local_media_port>**
&lt;local_media_port>9140&lt;/local_media_port>

**&lt;current_application>bridge&lt;/current_application>**
&lt;current_application>bridge&lt;/current_application>

**&lt;originate_disposition>SUCCESS&lt;/originate_disposition>**
&lt;originate_disposition>SUCCESS&lt;/originate_disposition>

**&lt;bridge_channel>OpenZAP/1%3A23/2137991400&lt;/bridge_channel>**
&lt;bridge_channel>OpenZAP/1%3A23/2137991400&lt;/bridge_channel>

**&lt;bridge_uuid>e012ce96-7f9c-4194-87fe-5ba86a3930ca&lt;/bridge_uuid>**
&lt;bridge_uuid>e012ce96-7f9c-4194-87fe-5ba86a3930ca&lt;/bridge_uuid>

**&lt;signal_bond>e012ce96-7f9c-4194-87fe-5ba86a3930ca&lt;/signal_bond>**
&lt;signal_bond>e012ce96-7f9c-4194-87fe-5ba86a3930ca&lt;/signal_bond>

**&lt;sip_nat_detected>true&lt;/sip_nat_detected>**
&lt;sip_nat_detected>true&lt;/sip_nat_detected>

**&lt;endpoint_disposition>ANSWER&lt;/endpoint_disposition>**
&lt;endpoint_disposition>ANSWER&lt;/endpoint_disposition>

**&lt;sip_user_agent>X-Lite%20release%201100l%20stamp%2047546&lt;/sip_user_agent>**
&lt;sip_user_agent>X-Lite%20release%201100l%20stamp%2047546&lt;/sip_user_agent>

**&lt;sip_term_status>200&lt;/sip_term_status>**
&lt;sip_term_status>200&lt;/sip_term_status>

**&lt;sip_term_cause>16&lt;/sip_term_cause>**
&lt;sip_term_cause>16&lt;/sip_term_cause>

**&lt;hangup_cause>NORMAL_CLEARING&lt;/hangup_cause>**
&lt;hangup_cause>NORMAL_CLEARING&lt;/hangup_cause>

**&lt;start_stamp>2008-07-31%2011%3A35%3A38&lt;/start_stamp>**
&lt;start_stamp>2008-07-31%2011%3A35%3A38&lt;/start_stamp>

**&lt;profile_start_stamp>2008-07-31%2011%3A35%3A38&lt;/profile_start_stamp>**
&lt;profile_start_stamp>2008-07-31%2011%3A35%3A38&lt;/profile_start_stamp>

**&lt;answer_stamp>2008-07-31%2011%3A35%3A41&lt;/answer_stamp>**
&lt;answer_stamp>2008-07-31%2011%3A35%3A41&lt;/answer_stamp>

**&lt;progress_stamp>2008-07-31%2011%3A35%3A38&lt;/progress_stamp>**
&lt;progress_stamp>2008-07-31%2011%3A35%3A38&lt;/progress_stamp>

**&lt;progress_media_stamp>2008-07-31%2011%3A35%3A38&lt;/progress_media_stamp>**
&lt;progress_media_stamp>2008-07-31%2011%3A35%3A38&lt;/progress_media_stamp>

**&lt;end_stamp>2008-07-31%2011%3A36%3A17&lt;/end_stamp>**
&lt;end_stamp>2008-07-31%2011%3A36%3A17&lt;/end_stamp>

**&lt;start_epoch>1217529338&lt;/start_epoch>**
&lt;start_epoch>1217529338&lt;/start_epoch>

**&lt;start_uepoch>1217529338212616&lt;/start_uepoch>**
&lt;start_uepoch>1217529338212616&lt;/start_uepoch>

**&lt;profile_start_epoch>1217529338&lt;/profile_start_epoch>**
&lt;profile_start_epoch>1217529338&lt;/profile_start_epoch>

**&lt;profile_start_uepoch>1217529338212616&lt;/profile_start_uepoch>**
&lt;profile_start_uepoch>1217529338212616&lt;/profile_start_uepoch>

&lt;answer_epoch>1217529338&lt;/answer_epoch>
    &lt;answer_uepoch>1217529338452698&lt;/answer_uepoch>
    &lt;end_epoch>1217529377&lt;/end_epoch>
    &lt;end_uepoch>1217529377795951&lt;/end_uepoch>
    &lt;last_app>bridge&lt;/last_app>
    &lt;last_arg>openzap/1/A/2137991400&lt;/last_arg>

    &lt;caller_id>"Mikey" &lt;1160>&lt;/caller_id>
    &lt;duration>39&lt;/duration>
    &lt;billsec>36&lt;/billsec>
    &lt;progresssec>0&lt;/progresssec>
    &lt;progress_mediasec>0&lt;/progress_mediasec>
    &lt;flow_billsec>39&lt;/flow_billsec>

    &lt;mduration>39583&lt;/mduration>
    &lt;billmsec>36267&lt;/billmsec>
    &lt;progressmsec>238&lt;/progressmsec>
    &lt;progress_mediamsec>237955&lt;/progress_mediamsec>
    &lt;flow_billmsec>39583&lt;/flow_billmsec>
    &lt;uduration>39583335&lt;/uduration>

    &lt;billusec>36267529&lt;/billusec>
    &lt;progressusec>237955&lt;/progressusec>
    &lt;progress_mediausec>237955&lt;/progress_mediausec>
    &lt;flow_billusec>39583335&lt;/flow_billusec>
    &lt;read_codec>PCMU&lt;/read_codec>
    &lt;read_rate>8000&lt;/read_rate>

```
&lt;/variables>
&lt;app_log>
  &lt;application app_name="set" app_data="open=true">&lt;/application>
  &lt;application app_name="set" app_data="use_profile=nat">&lt;/application>
  &lt;application app_name="set_user" app_data="default@192.168.50.229">&lt;/application>
  &lt;application app_name="db" app_data="insert/spymap/1160/6f32e2f8-38d1-43a7-b6ea-215bbfe6a314">&lt;/application>
  &lt;application app_name="db" app_data="insert/last_dial/1160/92137991400">&lt;/application>
  &lt;application app_name="db" app_data="insert/last_dial/global/6f32e2f8-38d1-43a7-b6ea-215bbfe6a314">&lt;/application>
  &lt;application app_name="record_session" app_data="/mnt/powervault/Databases/XMLCDR/6f32e2f8-38d1-43a7-b6ea-215bbfe6a314__1.wav">&lt;/application>

  &lt;application app_name="bridge" app_data="openzap/1/A/2137991400">&lt;/application>
&lt;/app_log>
&lt;callflow dialplan="XML" profile_index="1">
  &lt;extension name="tod_example" number="92137991400">
    &lt;application app_name="set" app_data="open=true">&lt;/application>
    &lt;application app_name="set" app_data="use_profile=${cond(${acl(${network_addr} rfc1918)} == true ? nat : default)}">&lt;/application>
    &lt;application app_name="set_user" app_data="default@${domain}">&lt;/application>
    &lt;application app_name="db" app_data="insert/spymap/${caller_id_number}/${uuid}">&lt;/application>
    &lt;application app_name="db" app_data="insert/last_dial/${caller_id_number}/${destination_number}">&lt;/application>
```

```
&lt;/variables>
&lt;app_log>
  &lt;application app_name="set" app_data="open=true">&lt;/application>
  &lt;application app_name="set" app_data="use_profile=nat">&lt;/application>
  &lt;application app_name="set_user" app_data="default@192.168.50.229">&lt;/application>
  &lt;application app_name="db" app_data="insert/spymap/1160/6f32e2f8-38d1-43a7-b6ea-215bbfe6a314">&lt;/application>
  &lt;application app_name="db" app_data="insert/last_dial/1160/92137991400">&lt;/application>
  &lt;application app_name="db" app_data="insert/last_dial/global/6f32e2f8-38d1-43a7-b6ea-215bbfe6a314">&lt;/application>
  &lt;application app_name="record_session" app_data="/mnt/powervault/Databases/XMLCDR/6f32e2f8-38d1-43a7-b6ea-215bbfe6a314__1.wav">&lt;/application>

  &lt;application app_name="bridge" app_data="openzap/1/A/2137991400">&lt;/application>
&lt;/app_log>
&lt;callflow dialplan="XML" profile_index="1">
  &lt;extension name="tod_example" number="92137991400">
    &lt;application app_name="set" app_data="open=true">&lt;/application>
    &lt;application app_name="set" app_data="use_profile=${cond(${acl(${network_addr} rfc1918)} == true ? nat : default)}">&lt;/application>
    &lt;application app_name="set_user" app_data="default@${domain}">&lt;/application>
    &lt;application app_name="db" app_data="insert/spymap/${caller_id_number}/${uuid}">&lt;/application>
    &lt;application app_name="db" app_data="insert/last_dial/${caller_id_number}/${destination_number}">&lt;/application>
```

```xml
    <extension>
      <application app_name="db" app_data="insert/last_dial/global/${uuid}"></application>
      <application app_name="record_session" app_data="/mnt/powervault/Databases/XMLCDR/${uuid}__1.wav"></application>
      <application app_name="bridge" app_data="openzap/1/A/2137991400"></application>
    </extension>
    <caller_profile>
      <username>1160</username>
      <dialplan>XML</dialplan>
      <caller_id_name>Mikey</caller_id_name>

      <ani></ani>
      <aniii></aniii>
      <caller_id_number>1160</caller_id_number>
      <network_addr>192.168.50.21</network_addr>
      <rdnis></rdnis>
      <destination_number>92137991400</destination_number>
      <uuid>6f32e2f8-38d1-43a7-b6ea-215bbfe6a314</uuid>

      <source>mod_sofia</source>
      <context>default</context>
      <chan_name>sofia/internal/1160@192.168.50.229</chan_name>
      <originatee>
        <originatee_caller_profile>
          <username>1160</username>
          <dialplan>XML</dialplan>

          <caller_id_name>Michael S Collins</caller_id_name>
          <ani></ani>
          <aniii></aniii>
          <caller_id_number>5597993757</caller_id_number>
          <network_addr>192.168.50.21</network_addr>
          <rdnis></rdnis>
          <destination_number>1/A/2137991400</destination_number>

          <uuid>e012ce96-7f9c-4194-87fe-5ba86a3930ca</uuid>
          <source>mod_sofia</source>
          <context>default</context>
          <chan_name>OpenZAP/1:23/2137991400</chan_name>
        </originatee_caller_profile>
      </originatee>
    </caller_profile>
```

```xml
<times>
  <created_time>1217529338212616</created_time>
  <profile_created_time>1217529338212616</profile_created_time>
  <progress_time>1217529338450571</progress_time>
  <progress_media_time>1217529338452698</progress_media_time>
  <answered_time>1217529341528422</answered_time>
  <hangup_time>1217529377795951</hangup_time>
  <transfer_time>0</transfer_time>
</times>
</callflow>
</cdr>

## 特点

### 输出功能

* 总是将日志记录到磁盘
* 总是将日志记录到HTTP/HTTPS
* 总是同时将日志记录到两者

### 可靠性功能

在失败时，它将将HTTP POST数据记录到您指定的磁盘，并具有可配置的超时和重试。

## 让它工作起来

### modules.conf

要编译这个模块，在modules.conf中取消注释mod_xml_cdr。

### 安装依赖项

如果您尝试构建并出现错误

[![错误](https://wiki.freeswitch.org/images/thumb/4/49/Error.png/64px-Error.png)](https://wiki.freeswitch.org/wiki/File:Error.png "错误")

---

**mod_xml_cdr.c:34:23: 错误: curl/curl.h: 没有那个文件或目录**

---

您需要安装curl和开发头文件。

##### Debian

[![输入以下命令](https://wiki.freeswitch.org/images/thumb/a/a9/Keyboard.png/64px-Keyboard.png)](https://wiki.freeswitch.org/wiki/File:Keyboard.png "输入以下命令")

apt-get install libcurl3-dev libcurl3

[![输入以下命令](https://wiki.freeswitch.org/images/thumb/a/a9/Keyboard.png/64px-Keyboard.png)](https://wiki.freeswitch.org/wiki/File:Keyboard.png "输入以下命令")

make install

在conf/autoload_configs/modules.conf.xml中加载该模块。

<load module="mod_xml_cdr"/>

在CLI中输入“load mod_xml_cdr”加载该模块。

### 示例配置
```

在 conf/autoload_configs 目录下编辑或创建一个名为 **xml_cdr.conf.xml** 的文件，内容如下：

[![Edit This](https://wiki.freeswitch.org/images/thumb/d/d2/Edit.png/64px-Edit.png)](https://wiki.freeswitch.org/wiki/File:Edit.png "Edit This")

&lt;configuration name="xml_cdr.conf" description="XML CDR CURL logger">
&lt;settings>
   &lt;param name="cred" value="user:pass"/>
   &lt;param name="url" value="<http://myhost/cdr.php>"/>
   &lt;param name="retries" value="2"/>
   &lt;param name="delay" value="120"/>
   &lt;param name="log-dir" value="/var/log/cdr"/>
   &lt;param name="err-log-dir" value="/var/log/cdr/errors"/>
   &lt;param name="encode" value="True"/>
&lt;/settings>

[![Informational Tip](https://wiki.freeswitch.org/images/thumb/b/b3/Info.png/64px-Info.png)](https://wiki.freeswitch.org/wiki/File:Info.png "Informational Tip")

---

* 你指定的 log-dir 或 err-log-dir 目录必须存在。
* 你需要创建自己的 HTTP CGI 处理程序来替换 cdr.php。查看 contrib/trixter/xml-cdr 目录下的示例 cdr.php 代码。
* 请仔细检查 freeswitch.xml 文件，确保已包含 xml_cdr.conf.xml。如果没有，说明你需要获取一个更新的 freeswitch 版本才能使用此功能。

---

默认的 GIT 配置（截至 2011-03-11）如下：

&lt;configuration name="xml_cdr.conf" description="XML CDR CURL logger">
  &lt;settings>
    &lt;!-- 如果为空，将禁用 web 提交，这是要提交到的 url  -->
    &lt;!-- &lt;param name="url" value="http://localhost/cdr_curl/post.php"/> -->

    &lt;!-- 可选：发送到 Web 服务器的凭据 -->
    &lt;!--    &lt;param name="cred" value="user:pass"/> -->

```xml
<!-- 在失败情况下，尝试将数据提交到Web服务器的总重试次数（不包括第一次） -->
<!-- <param name="retries" value="2"/> -->

<!-- 重试之间的延迟时间（以秒为单位），默认为5秒 -->
<!-- <param name="delay" value="1"/> -->

<!-- 是否通过HTTP和磁盘记录日志，默认为false -->
<!-- <param name="log-http-and-disk" value="true"/> -->

<!-- 可选：如果不存在，我们不记录每个记录到磁盘 -->
<!-- 可以是绝对路径、相对路径（假设为${prefix}/logs）或空值，默认为${prefix}/logs/xml_cdr -->
<param name="log-dir" value=""/>

<!-- 可选：如果不存在，我们会记录B路的呼叫日志 -->
<!-- 是否为呼叫的B路创建CDR，true或false -->
<param name="log-b-leg" value="false"/>

<!-- 可选：如果不存在，所有文件名都是呼叫的UUID -->
<!-- 是否为A路的日志文件添加前缀"a_"，true或false -->
<param name="prefix-a-leg" value="true"/>

<!-- 编码提交的数据，可以是'true'表示URL编码，'false'表示不编码，'base64'表示Base64编码 -->
<param name="encode" value="true"/>

<!-- 可选：设置为true以禁用Expect: 100-continue，lighttpd需要这个设置 -->
<!-- <param name="disable-100-continue" value="true"/> -->

<!-- 可选：失败的Web提交的错误日志目录的完整路径，如果未指定，与log-dir相同 -->
<!-- 可以是绝对路径、相对路径（假设为${prefix}/logs）或空值，默认为${prefix}/logs/xml_cdr -->
<!-- <param name="err-log-dir" value="/tmp"/> -->
```

```xml
<!-- 选择要使用的认证方案。支持的值有：basic，digest，NTLM，GSS-NEGOTIATE 或 "any" 以自动检测 -->
<!--&lt;param name="auth-scheme" value="basic"/>-->

<!-- 可选：启用 libcurl 进行 CA 根证书检查，以验证证书是否由主要的证书颁发机构颁发。
     注意：默认值为禁用。只有想要启用时才启用！ -->
<!--&lt;param name="enable-cacert-check" value="true"/>-->
<!-- 可选：验证服务器是否确实是证书中所列的服务器 -->
<!-- &lt;param name="enable-ssl-verifyhost" value="true"/> -->

<!-- 可选：可以使用这些选项指定用于 HTTPS 通信的自定义 SSL 证书。
     要么同时使用这两个选项，要么都不使用。
     使用 'ssl-cert-path' 指定公钥，使用 'ssl-key-path' 指定私钥。
     如果私钥有密码，请使用 'ssl-key-password' 指定密码。 -->
<!-- &lt;param name="ssl-cert-path" value="$${base_dir}/conf/certs/public_key.pem"/> -->
<!-- &lt;param name="ssl-key-path" value="$${base_dir}/conf/certs/private_key.pem"/> -->
<!-- &lt;param name="ssl-key-password" value="MyPrivateKeyPassword"/> -->

<!-- 可选：使用自定义 PEM 格式的 CA 证书来验证对等方。
     如果您自己担任证书颁发机构，则这很有用。
     注意：只有与 "enable-cacert-check" 结合使用才有意义。 -->
<!-- &lt;param name="ssl-cacert-file" value="$${base_dir}/conf/certs/cacert.pem"/> -->
```

```html
&lt;!-- 可选项：指定要使用的 SSL 版本强制使用 HTTPS。有效选项为 "SSLv3" 和 "TLSv1"。如果不指定，libcurl 将自动协商版本。 -->
&lt;!-- &lt;param name="ssl-version" value="TLSv1"/> -->

&lt;!-- 可选项：启用 cookie 并将其存储在指定的文件中。 -->
&lt;!-- &lt;param name="cookie-file" value="/tmp/cookie-mod_xml_curl.txt"/> -->
&lt;/settings>
&lt;/configuration>

#### 验证

进行一次呼叫，挂断后，您应该在 /usr/local/freeswitch/log 目录下看到一个新的 XML 文件。还要检查您的网页服务器日志。

### 配置选项
```

| **名称**                | **描述**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | **示例**                                |
| ----------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------- |
| log-b-leg               | 是否记录 B legs（默认只记录 A legs）                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | true                                   |
| url                     | Web 服务器 URL（可以多次指定该参数，程序将按照顺序尝试每个 URL，直到达到重试次数。注意重试次数不针对每个 URL 指定）。注意 URL 是可选的，mod_xml_cdr 只能将数据写入磁盘。                                                                                                                                                                                                                                                                                                                                                    | <http://myhost/cdr.php>                |
| cred                    | 发送到 Web 服务器的凭证（如果 Web 服务器需要）                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | user:pass                              |
| auth-scheme             | 要使用的身份验证方案。支持的值有：basic，digest，NTLM，GSS-NEGOTIATE 或 "any"（自动检测）                                                                                                                                                                                                                                                                                                                                                                                                                                        | basic                                  |
| encode                  | 是否对发送到 Web 服务器的 POST 数据进行编码。默认情况下（如果未提供此参数或参数无效），POST 请求的内容类型为 application/x-www-form-plaintext，并且不对 POST 数据进行 URL 编码。如果设置为 'True'，将设置内容类型为 application/x-www-form-urlencoded，并对信息进行 URL 编码。这是大多数 Web 服务器所期望的。如果设置为 base64，内容类型将为 application/x-www-form-base64-encoded。最后，如果设置为 textxml，内容类型将为 text/xml。                                                                                            | base64                                 |
| retries                 | 在放弃 HTTP POST 并写入磁盘之前的重试次数                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | 2                                      |
| timeout                 | HTTP 请求超时时间                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | 20                                     |
| delay                   | 重试之前的延迟时间（以秒为单位）                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | 120                                    |
| enable-cacert-check     | 是否检查服务器的 SSL 证书与 CA 证书的匹配性（推荐用于 HTTPS）                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | true                                   |
| enable-ssl-verifyhost   | 是否检查服务器的 SSL 证书与 URL 的主机名是否匹配（推荐用于 HTTPS）                                                                                                                                                                                                                                                                                                                                                                                                                                                            | true                                   |
| ssl-cacert-file         | CA 证书文件的路径。注意：由于模块不会自动搜索系统 CA，所以此参数似乎是必需的。                                                                                                                                                                                                                                                                                                                                                                                                                                                     | /etc/ssl/certs/ca-certificates.crt     |
| ssl-cert-path           | 客户端证书的路径                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | /etc/ssl/certs/fs_client.crt          |
| ssl-key-path            | 客户端私钥的路径                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | /etc/ssl/private/fs_client.key         |
| ssl-key-password        | 客户端私钥的密码                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | mysecret                               |
| ssl-version             | 要使用的 SSL/TLS 版本。支持的值为 "SSLv3" 或 "TLSv1"                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | TLSv1                                  |
| disable-100-continue    | 禁用 HTTP Expect 头中的 100 Continue，对于不喜欢这个选项的服务器。                                                                                                                                                                                                                                                                                                                                                                                                                                                              | true                                   |
| log-http-and-disk       | 默认行为是在 HTTP 失败时将数据写入 HTTP 或磁盘。将此参数设置为 true，无论如何都会将数据写入 HTTP 和磁盘（如果需要实时监控 + 后期对帐，这非常有用）                                                                                                                                                                                                                                                                                                                                                                      | true                                   |
| log-dir                 | 日志目录 - **您必须先创建此目录**。如果留空，则使用默认目录。如果省略，将禁用日志记录到文件并且只会 POST 到 Web 服务器。如果给定一个名称而不是路径，则将使用默认目录下的子目录。这个目录必须已经存在。                                                                                                                                                                                                                                                                                                                                                   | /tmp/log                               |
| err-log-dir             | 错误日志目录 - **您必须先创建此目录**。如果留空，则使用默认目录。如果省略，将禁用日志记录到文件并且只会 POST 到 Web 服务器。如果给定一个名称而不是路径，则将使用默认目录下的子目录。这个目录必须已经存在。                                                                                                                                                                                                                                                                                                                                            | /tmp/errlog                            |
| prefix-a-leg            | 在 A leg 文件名前加上 a_，以区分 A leg 和 B leg 的 CDRs                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | true                                   |
| rotate                  | 是否轮转写入 CDR 的目录。如果启用，将日志写入在程序加载时创建的 log-dir 的 yyyy-mm-dd-hh-mm-ss 子目录中，并在 SIGHUP 时切换到新目录。一个目录中的大量文件可能会成为性能瓶颈，这会限制在打开/创建该目录中/下的路径时的尝试次数，因此可以提高磁盘日志记录的性能。                                                                                                                                                                                                                                                                                                               | true                                   |

### 处理POST请求

通过HTTP或HTTPS，可以向任何Web服务器发送POST请求。用来处理请求的脚本可以使用您选择的任何语言。

POST请求由一个名为**cdr**的单个变量组成，其中包含CDR作为XML文档（与写入磁盘的相同数据）。

如果将"prefix-a-leg"设置为true，则所提交的URL将包含在GET字符串中："?uuid=a\_$uuid" 用于a leg。

如果页面返回的HTTP状态码为200 OK，则请求被视为成功。任何其他状态码都将被视为失败，这将导致mod\_xml\_cdr进行重试请求、尝试下一个服务器或写入磁盘。不需要输出；只使用状态码来检查请求是否成功。

您可以使用可用于您选择的语言内部的XML解析器解析cdr变量的内容。它的外观类似于：

```xml
<?xml version="1.0"?>
<cdr>
  <channel_data>
    <state>CS_REPORTING</state>
    <direction>呼入</direction>
    <state_number>11</state_number>
    <flags>0=1;36=1;38=1;51=1</flags>
    <caps>1=1;2=1;3=1</caps>
  </channel_data>
  <variables>
    <uuid>2e831835-d336-4735-b3e5-90e5d7dc8187</uuid>
    <sip_network_ip>192.168.0.2</sip_network_ip>
    <sip_network_port>56866</sip_network_port>
    <sip_received_ip>192.168.0.2</sip_received_ip>
    <sip_received_port>56866</sip_received_port>
    <sip_via_protocol>udp</sip_via_protocol>
    <sip_from_user>1000</sip_from_user>
    <sip_from_uri>1000%40192.168.0.2</sip_from_uri>
    <sip_from_host>192.168.0.2</sip_from_host>
    <sip_from_user_stripped>1000</sip_from_user_stripped>
    <sip_from_tag>BD37552C-4B5</sip_from_tag>
    ...
  </variables>
  <app_log>
    <application app_name="set" app_data="continue_on_fail=true"></application>
    <application app_name="bridge" app_data="sofia/external/gateway/gw001/1000"></application>
    <application app_name="bridge" app_data="sofia/external/gateway/gw002/1000"></application>
  </app_log>
  <callflow dialplan="XML" profile_index="1">
    <extension name="1000" number="1000">
      <application app_name="set" app_data="continue_on_fail=true"></application>
      <application app_name="bridge" app_data="sofia/external/gateway/gw001/1000"></application>
      <application app_name="bridge" app_data="sofia/external/gateway/gw002/1000"></application>
      <application app_name="bridge" app_data="sofia/external/gateway/gw003/1000"></application>
      <application app_name="bridge" app_data="sofia/external/gateway/gw004/1000"></application>
      <application app_name="bridge" app_data="sofia/external/gateway/gw005/1000"></application>
    </extension>
  </callflow>
  <caller_profile>
    <username>1000</username>
    <dialplan>XML</dialplan>
    <caller_id_name>1000</caller_id_name>
    <ani>1000</ani>
    <aniii></aniii>
    <caller_id_number>1000</caller_id_number>
    <network_addr>192.168.0.2</network_addr>
    <rdnis>1000</rdnis>
    <destination_number>1000</destination_number>
    <uuid>2e831835-d336-4735-b3e5-90e5d7dc8187</uuid>
    <source>mod_sofia</source>
    <context>default</context>
    <chan_name>sofia/default/1000@192.168.0.2</chan_name>
  </caller_profile>
  <times>
    <created_time>1274439432438053</created_time>
    <profile_created_time>1274439432448060</profile_created_time>
    <progress_time>0</progress_time>
    <progress_media_time>0</progress_media_time>
    <answered_time>0</answered_time>
    <hangup_time>1274439438418776</hangup_time>
    <resurrect_time>0</resurrect_time>
    <transfer_time>0</transfer_time>
  </times>
</cdr>
```
```

显然，所有的值都是URL编码的。这与之前FreeSWITCH wiki所声称的XML不是一部分。只是通过URL编码值，您可以删除会破坏XML值(&,&lt;,>)的字符的使用，并且不需要进一步的转义。因此，在读取任何元素的值时，您需要进行URI解码。一个正确的XML解析器不会为您完成这个操作：您将得到一个编码后的值。在上面的示例中，XML解析器将返回变量sip_from_uri的值"1000%40192.168.0.2"。如果有人知道为什么在这里使用URL编码而不是使用XML（这将节省很多字节，特别是将失败的bleg XML CDR编码为变量），请添加到wiki中。

#### 示例

请参阅  scripts/contrib/trixter/xml-cdr 以获取将 webpost（现在使用 mod_xml_cdr）转换为关联数组的示例，以便您的脚本可以处理它。

  
在.Net MVC3中处理xml_cdr的Post请求

        [HttpPost]
        public void CDR(string uuid)
        {
            var auth = ASCIIEncoding.ASCII.GetString(
                       Convert.FromBase64String(Request.Headers["AUTHORIZATION"]));

            // TODO: 使用auth检查用户：密码是否经过授权。
            
            // 从输入流获取xml。
            StreamReader r = new StreamReader(Request.InputStream);
            string xml = r.ReadToEnd();
            // 去掉一些不必要的字符。
            xml.Substring(4, xml.Length - 4);

            // 解析字符串。以下示例使用了XElement，但您也可以使用XmlDocument。
            XElement elm = XElement.Parse(xml);

```python
            // 现在使用 xpath 或 LINQ 抓取所需的元素值。
            // 例如: YOUR_ELEMENT 可能等于 variables/hangup_cause。
            string selectedElm = Uri.UnescapeDataString(elm.XPathSelectElement("//" + "YOUR_ELEMENT").Value); 
        }

### 重新提交失败的 CDR 提交

在 ./conf/autoload\_configs/xml\_cdr.conf.xml 中，您可以激活 "err-log-dir" 选项，如果 http cdr 服务器出现问题，将日志记录在目录中。

当修复了导致 CDR 提交失败的错误后，您将希望重新发送 CDR 到服务器。

用于执行此操作的 curl 命令如下:

 curl --request POST --fail --data-urlencode cdr@$CDR http://$CDR_SERVER_URI/ >/dev/null \

#### 脚本（用于 cronjob 或手动运行）

此脚本适用于从命令行或 cronjob 运行。它从 mod\_xml\_cdr 配置文件中读取所有必要的服务器详细信息。

您需要安装 libxml2-utils 和 curl。

#!/bin/sh

# 配置文件位置
# 根据您的本地安装环境进行调整。
CONFIG_FILE=/etc/freeswitch/autoload_configs/xml_cdr.conf.xml

# 读取配置

get_param()
{
    NAME=$1
    xmllint $CONFIG_FILE -xpath "string(/configuration/settings/param[@name='$NAME']/@value)"
}

CDRDIR=$(get_param err-log-dir)
URL=$(get_param url)
AUTH_SCHEME=$(get_param auth-scheme)
CRED=$(get_param cred)
```

＃重新提交错误目录中的所有CDR。成功的HTTP请求将删除文件。
＃注意错误的CDR已经存储为URLEncoded的形式。
for CDR in $(find $CDRDIR -name "*.cdr.xml"); do
    echo "正在重新提交 $(basename $CDR .cdr.xml)..."
    echo -n 'cdr='$(cat $CDR) | \
        curl -sS -X POST -f --$AUTH_SCHEME -u $CRED -d @- $URL >/dev/null \
            && echo "好的，删除CDR文件" \
            && rm -f $CDR
done

＃以下适用于上传记录到磁盘的CDR（这些尚未进行URLEncoded处理，所以必须进行不同的处理）
＃for CDR in $(find $CDRDIR -name "*.cdr.xml"); do
#        echo "正在重新提交 $(basename $CDR .cdr.xml)..."
#        curl -sS --request POST --fail --$AUTH_SCHEME --user $CRED --data-urlencode cdr@$CDR $URL >/dev/null \
#                && echo "好的，删除CDR文件" \
#                && rm -f $CDR
#done

**注意**此脚本假定您正在使用基本/摘要密码身份验证。如果您不使用身份验证或客户端证书，则需要修改此脚本。

### 参考信息

通过PSTN呼叫FreeSWITCH会议生成了[示例XML CDR](https://wiki.freeswitch.org/wiki/Example%5FXML%5FCDR "示例XML CDR")。注册到FS的SIP电话拨打了9+2137991400，并通过该拨号计划扩展进行了处理：

  &lt;!-- 拨打9，通过第1个端口的Qwest PRI 线路外呼 -->
  &lt;extension name="Dial 9">
    &lt;condition field="destination_number" expression="^9(\d{10})$">
      &lt;action application="bridge" data="freetdm/1/A/$1"/>
    &lt;/condition>
  &lt;/extension>

#### 通道变量

XML CDR包含一些通道变量以及呼叫流程信息。  
呼叫时间以日期/时间戳格式表示，或以纪元秒或纪元微秒（usec）表示。  
日期/时间戳变量经过URI编码，因此在将其插入数据库之前，请确保进行“URI解码”。  
例如："2008-07-31%2011%3A35%3A38"是URI编码的。解码后为"2008-07-31 11:35:38"。  
纪元始于1970-01-01 00:00:00，因此纪元值是自纪元开始以来的秒数（或微秒数）。  
使用纪元微秒值可以进行非常精确的测量。  

##### 呼叫日期/时间变量

###### answer_stamp

实际应答呼叫的日期/时间。  
在 [示例CDR](https://wiki.freeswitch.org/wiki/Example%5FXML%5FCDR) 中，此值为 "2008-07-31%2011%3A35%3A41"（2008-07-31 11:35:41）。

###### end_stamp

呼叫终止的日期/时间。  
在 [示例CDR](https://wiki.freeswitch.org/wiki/Example%5FXML%5FCDR) 中，此值为 "2008-07-31%2011%3A36%3A17"（2008-07-31 11:36:17）。

###### profile_start_stamp

###### progress_stamp

收到远端进度信息的日期/时间。

###### progress_media_stamp

第一次接收到“早期媒体”或进度媒体的日期/时间。 "早期媒体"包括回铃音（RBT）。  
在 [示例CDR](https://wiki.freeswitch.org/wiki/Example%5FXML%5FCDR) 中，此值为 "2008-07-31%2011%3A35%3A38"（2008-07-31 11:35:38）。

###### start_stamp

呼叫发起的日期/时间。  
在 [示例CDR](https://wiki.freeswitch.org/wiki/Example%5FXML%5FCDR) 中，此值为 "2008-07-31%2011%3A35%3A38"（2008-07-31 11:35:38）。

##### 呼叫纪元变量

###### answer_epoch

以 epoch 秒为单位的应答时间。
在[示例CDR](https://wiki.freeswitch.org/wiki/Example%5FXML%5FCDR "Example XML CDR")中，该值为 1217529338。

###### answer_uepoch

以 epoch 微秒为单位的应答时间。
在[示例CDR](https://wiki.freeswitch.org/wiki/Example%5FXML%5FCDR "Example XML CDR")中，该值为 1217529338452698。

###### end_epoch

以 epoch 秒为单位的通话结束时间。
在[示例CDR](https://wiki.freeswitch.org/wiki/Example%5FXML%5FCDR "Example XML CDR")中，该值为 1217529377。

###### end_uepoch

以 epoch 微秒为单位的通话结束时间。
在[示例CDR](https://wiki.freeswitch.org/wiki/Example%5FXML%5FCDR "Example XML CDR")中，该值为 1217529377795951。

###### profile_start_epoch

以 epoch 秒为单位的配置文件开始时间。
在[示例CDR](https://wiki.freeswitch.org/wiki/Example%5FXML%5FCDR "Example XML CDR")中，该值为 1217529338。

###### profile_start_uepoch

以 epoch 微秒为单位的配置文件开始时间。
在[示例CDR](https://wiki.freeswitch.org/wiki/Example%5FXML%5FCDR "Example XML CDR")中，该值为 1217529338212616。

###### start_epoch

以 epoch 秒为单位的呼叫开始时间。
在[示例CDR](https://wiki.freeswitch.org/wiki/Example%5FXML%5FCDR "Example XML CDR")中，该值为 1217529338。

###### start_uepoch

以 epoch 微秒为单位的呼叫开始时间。
在[示例CDR](https://wiki.freeswitch.org/wiki/Example%5FXML%5FCDR "Example XML CDR")中，该值为 1217529338212616。

##### 通话时长变量

###### billsec

以秒为单位的可计费通话时长。可计费时间不包括通话开始前 "早期媒体" 中花费的通话时间。
在[示例CDR](https://wiki.freeswitch.org/wiki/Example%5FXML%5FCDR "Example XML CDR")中，该值为 36。

###### billmsec

计费通话持续时间，以毫秒计。计费时间不包括在远端接听呼叫之前在“早期媒体”中花费的呼叫时间。
在[示例CDR](https://wiki.freeswitch.org/wiki/Example%5FXML%5FCDR "Example XML CDR")中，该值为36267。

###### billusec

计费通话持续时间，以微秒计。计费时间不包括在远端接听呼叫之前在“早期媒体”中花费的呼叫时间。
在[示例CDR](https://wiki.freeswitch.org/wiki/Example%5FXML%5FCDR "Example XML CDR")中，该值为36267529。

###### duration

呼叫的总持续时间，以秒计。  
在[示例CDR](https://wiki.freeswitch.org/wiki/Example%5FXML%5FCDR "Example XML CDR")中，该值为39。

###### flow_billsec

###### flow_billmsec

###### flow_billusec

###### mduration

呼叫的总持续时间，以毫秒计。  
在[示例CDR](https://wiki.freeswitch.org/wiki/Example%5FXML%5FCDR "Example XML CDR")中，该值为39583。

###### progresssec

SIP邀请和SIP 180消息之间的时间，以秒计算。  
在[示例CDR](https://wiki.freeswitch.org/wiki/Example%5FXML%5FCDR "Example XML CDR")中，该值为0（小于1秒）。

###### progressmsec

SIP邀请和SIP 180消息之间的时间，以毫秒计算。  
在[示例CDR](https://wiki.freeswitch.org/wiki/Example%5FXML%5FCDR "Example XML CDR")中，该值为238。

###### progressusec

SIP邀请和SIP 180消息之间的时间，以微秒计算。  
在[示例CDR](https://wiki.freeswitch.org/wiki/Example%5FXML%5FCDR "Example XML CDR")中，该值为237955。

###### progress_mediasec

在SIP邀请和SIP 183消息之间的时间间隔，以秒为单位  
在[示例CDR](https://wiki.freeswitch.org/wiki/Example%5FXML%5FCDR "Example XML CDR")中，该值为0（小于1秒）。

###### progress_mediamsec

在SIP邀请和SIP 183消息之间的时间间隔，以毫秒为单位  
在[示例CDR](https://wiki.freeswitch.org/wiki/Example%5FXML%5FCDR "Example XML CDR")中，该值为238。

###### progress_mediausec

在SIP邀请和SIP 183消息之间的时间间隔，以微秒为单位  
在[示例CDR](https://wiki.freeswitch.org/wiki/Example%5FXML%5FCDR "Example XML CDR")中，该值为237955。

###### uduration

通话的总持续时间，以微秒为单位。  
在[示例CDR](https://wiki.freeswitch.org/wiki/Example%5FXML%5FCDR "Example XML CDR")中，该值为39583335。

### 故障排除

#### 加载模块时出现错误

2007-06-27 17:59:12 [ERR] switch_loadable_module.c:714 switch_loadable_module_load_file() Error 
Loading module /usr/local/freeswitch/mod/mod_xml_cdr.so
**/usr/local/freeswitch/mod/mod_xml_cdr.so: undefined symbol: curl_easy_getinfo**

解决方法：这表示您的curl链接不正确。请检查mod\_xml\_cdr/Makefile，确保它具有WANTS\_CURL=yes。

#### 不写入非默认的logDir目录

如果您将logDir设置为/tmp/foo，则必须创建/tmp/foo/xml\_cdr目录，否则它会恢复到默认目录。

#### 模块加载时出现内存错误

2007-06-27 19:41:06 [DEBUG] mod_xml_cdr.c:192 do_config() processing logDir config
2007-06-27 19:41:06 [DEBUG] mod_xml_cdr.c:197 do_config() val is NON zero length, setting globals.logDir: /tmp/log
2007-06-27 19:41:06 [CRIT] mod_xml_cdr.c:219 do_config() Memory Error!

修复：尝试在配置中设置自定义的 errLogDir，这个错误就会消失。这是一个bug，并不是实际上表示内存相关问题的内存错误。

### 示例 CGI 脚本

以下是一个用 Perl 编写的简单的 CGI 脚本，演示了如何处理来自 mod\_xml\_cdr 的 POST 的 XML CDR 数据。以下是要求：

* Web 服务器（已在 Apache 下测试通过）
* 脚本所在目录有执行权限（已在我的 Apache 安装中的 /cgi-bin 目录下测试通过）
* 对一个目录有写访问权限（已在我的系统的 /tmp 目录下测试通过）
* 来自 CPAN 的 XML::Simple（在命令行中运行 "cpan"，然后执行 "install XML::Simple"）
* 来自 CPAN 的 CGI::Simple（在命令行中运行 "cpan"，然后执行 "install CGI::Simple"）

我在我的 xml\_cdr.conf.xml 中使用了以下配置选项：

&lt;param name="url" value="<http://localhost/cgi-bin/fs-xml-cdr.pl>"/>

当 XML CDR 被 POST 到 Web 服务器时，脚本就会被启动。我认为你会发现注释非常详细，给了你很多帮助。最终的结果是你有一个/tmp/fs-xml-cdr.log 文件，其中写有各种有趣的信息片段，此外还有一个将原始 XML 转换为数据结构的示例，以及创建 CSV 记录和 SQL INSERT 语句的示例。

#### 代码清单 \[Perl\]

#
# fs-xml-cdr.pl
#
# 这是一个守护进程的示例，用于接收 XML CDR 信息并为你提供一些可以处理的内容
# 也可以用来启动直接写入数据库的过程

use strict;
use warnings;

use XML::Simple; # 从 CPAN 获取
use CGI::Simple; # 从 CPAN 获取
use Data::Dumper;

# 将数据写入一个位置供进一步查看
open(FILEOUT,">>",'/tmp/fs-xml-cdr.log');

# $cgi 对象有一些有用的方法
my $cgi = new CGI::Simple;

# 从 CGI 调用中获取实际的 cdr 数据
my $cdr = $cgi->param('cdr');

```perl
# 将原始XML数据转储到文件
print FILEOUT "原始XML通话详单：\n\n";
print FILEOUT $cdr . "\n";

# 将通话详单信息放入一个简单对象中
my $xml_cdr;
eval { $xml_cdr = XMLin($cdr, ForceArray => 1); };

if ( $@ ) {
  print FILEOUT "解析XML时发生错误：$@\n";
}

# 访问通话详单信息
print FILEOUT "我的 leg UUID 是：" . $xml_cdr->{variables}->[0]->{uuid}->[0] . "\n";
print FILEOUT "另一个 leg UUID 是：" . $xml_cdr->{variables}->[0]->{bridge_uuid}->[0] . "\n\n";

# 查看整个数据结构
print FILEOUT "\$xml_cdr 的结构如下所示：\n\n";
print FILEOUT Dumper($xml_cdr) . "\n";

# URL 解码
$cdr = $cgi->url_decode($cdr);

# 转储URL解码后的XML数据
print FILEOUT "解码后的XML通话详单：\n\n";
print FILEOUT $cdr . "\n";

# 将特定字段转储到CSV文件或数据库或其他你想要的地方
# 按照希望在数据库或CSV中出现的顺序添加字段到这个数组
# 根据需要添加/删除字段名
my @fields = (
  'uuid',
  'bridge_uuid',
  'direction',
  'billsec',
  'start_epoch',
  'end_epoch',
);

my @data;  # 存放字段数据
my $csv;   # 格式化的CSV记录
my $sql;   # SQL插入语句（假设表字段名与 @fields 中的字段名相匹配）

# 构建一个 @data 数组
foreach (0..$#fields) {
  my $field = $fields[$_];
  # 如果需要对任何字段进行特殊格式化，则在此处处理
  # 否则将其直接放入数组
  push @data, $xml_cdr->{variables}->[0]->{$field}->[0];
}

# 构建一个简单的CSV记录
$csv = join ",", @data;
print FILEOUT "CSV记录如下：\n";
print FILEOUT $csv . "\n\n";
```

# 构建一个简单的 SQL 插入语句
$sql  = 'INSERT INTO cdr(';
$sql .= join ",",@fields;
$sql .= ") VALUES ('";
$sql .= join "','",@data;
$sql .= "')";
print FILEOUT "SQL 插入命令如下：\n";
print FILEOUT $sql . "\n\n";

print FILEOUT "= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =\n\n";
close(FILEOUT);

### 常见问题解答

#### Q: mod_cdr 需要编译/启用吗？

不需要，这个模块是独立的，你可以同时拥有两者而不会发生冲突，它们不会相互通信。