# mod_expr

## 关于

mod_expr实现了Brian Allen Vanderburg的ExprEval表达式求值库，用于FreeSWITCH。

单击此处展开目录

* 1 [概述](#overview)
* 2 [使用场景](#use-cases)  
   * 2.1 [控制台](#console)  
   * 2.2 [拨号计划](#dialplan)
* 3 [表达式语法](#expression-syntax)  
   * 3.1 [操作符的顺序](#order-of-operators)  
   * 3.2 [ExprEval内部函数](#expreval-internal-functions)  
   * 3.3 [ExprEval内部常量](#expreval-internal-constants)

### 概述

该模块提供表达式求值功能，使您可以在可以调用模块代码的任何上下文中进行数学运算。您最有可能使用这个功能的地方是[dialplan](../Dialplan/index.mdx#0-about)。

语法允许您创建由分号分隔的多个部分的表达式。然后，您可以创建临时变量，用于构建更复杂的表达式。

### 使用场景

#### 控制台

从命令行可以执行以下操作：

```xml
freeswitch@internal> expr 1+1
2
freeswitch@internal> expr 2/4
0.5
freeswitch@internal> expr sin(0)
0
freeswitch@internal> expr cos(0)
1
freeswitch@internal> expr randomize(&x);ceil(random(0,100,&x))
39
```

当然，您也可以通过fs_cli或事件套接字调用这个功能。

#### 拨号计划

您可以在拨号计划中使用expr，使用${...}语法。示例：

```xml
<!-- 生成1到100之间的随机数 -->
<action application="set" data="rand_val=${expr(randomize(&x);ceil(random(0,100,&x)))}"/>
<action application="log" data="INFO 随机值为 ${rand_val}"/>
```

假设您想要检查客户的余额是否低于零，而无需调用脚本，并执行拨号计划：

**查看客户信用余额**

```xml
<action application="set" data="balance=0.55" />
<action application="set" data="myext=${expr(select(above(${balance}, 0) - 0.5, 514, 515))}" />
<action application="transfer" data="${myext} XML mydialplan" />
```

你可以使用 **下面** 的表达式，并进行逻辑修改。

### 表达式语法

如果构建一个复合表达式，每个内部短语必须以分号结尾。表达式的值是最后一个短语的值。

```xml
4*x+5
y=5+2;g=4+6
y=r*sin(a);x=r*cos(a)
```

星号 '\*' 用于乘法运算。圆括号 () 用于设置优先级。

一些函数可以采用引用参数。这些参数是对其他变量的引用。你可以将引用参数与普通参数混合使用。普通参数的顺序必须保持不变，并且引用参数的顺序必须保持不变。

```xml
min(1,2,3,4,&mval);		&mval 是对变量 mval 的引用
min(1,2,&mval,3,4); 	你可以在内部混用它们
min(1,2,(&mval),3,4);	你不能以任何方式嵌套引用参数
```

表达式还可以包含空格字符和注释。空格字符，如换行符、回车符、制表符、空格和制表符，都会被忽略。注释以井号 '#' 开头，直到行尾结束。

如果表达式中使用了一个变量，但该变量不存在，则被视为零。如果该变量存在，则使用其值。

注意：表达式无法将值赋给常量，也无法将常量用作引用参数。

#### 运算符的顺序

运算符的顺序在 ExprEval 中正确处理。函数的参数可能会按照不同的顺序进行评估，具体取决于函数本身。

下面列举了运算符的顺序：

| 运算符                        | 方向           | 示例              |
| --------------------------- | ------------- | ------------------ |
| 函数和括号                     | 不可用         | (x + 5) \* sin(d); |
| 取反                         | 从右至左       | y = -2;            |
| 幂                           | 从左至右       | y = x ^ 2;         |
| 乘法和除法                     | 从左至右       | x \* 5 / y;        |
| 加法和减法                     | 从左至右       | 4 + 5 - 3;         |
| 赋值                         | 从右至左       | x = y = z = 0;     |

#### ExprEval 内部函数

以下是 ExprEval 提供的函数：

| 功能                           | 最少参数 | 最多参数 | 最少引用参数 | 最多引用参数 | 结果/注释                                                                                                                                                                                                                                                                                                                                                            |
| ------------------------------ | -------- | -------- | ------------ | ------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| abs(v)                         | 1        | 1        | 0            | 0            | 取绝对值 abs(-4.3) 返回 4.3                                                                                                                                                                                                                                                                                                                                           |
| mod(v,d)                       | 2        | 2        | 0            | 0            | 取余数 mod(5.2,2.5) 返回 0.2                                                                                                                                                                                                                                                                                                                                          |
| ipart(v)                       | 1        | 1        | 0            | 0            | 取整数部分 ipart(3.2) 返回 3                                                                                                                                                                                                                                                                                                                                           |
| fpart(v)                       | 1        | 1        | 0            | 0            | 取小数部分 fpart(3.2) 返回 0.2                                                                                                                                                                                                                                                                                                                                          |
| min(v,...)                     | 1        | 无       | 0            | 0            | 取传入数字中的最小值 min(3,2,-5,-2,7) 返回 -5                                                                                                                                                                                                                                                                                                                          |
| max(v,...)                     | 1        | 无       | 0            | 0            | 取传入数字中的最大值 max(3,2,-5,-2,7) 返回 7                                                                                                                                                                                                                                                                                                                           |
| pow(a,b)                       | 2        | 2        | 0            | 0            | a 的 b 次方 pow(3.2,1.7) 返回 3.2 的 1.7 次方                                                                                                                                                                                                                                                                                                                         |
| sqrt(a)                        | 1        | 1        | 0            | 0            | 取平方根 sqrt(16) 返回 4                                                                                                                                                                                                                                                                                                                                               |
| sin(a)                         | 1        | 1        | 0            | 0            | 取 a 弧度的正弦值 sin(1.5) 返回约 0.997                                                                                                                                                                                                                                                                                                                                 |
| sinh(a)                        | 1        | 1        | 0            | 0            | 取 a 的双曲正弦值 sinh(1.5) 返回约 2.129                                                                                                                                                                                                                                                                                                                                |
| asin(a)                        | 1        | 1        | 0            | 0            | 取 a 弧度的反正弦值 asin(0.5) 返回约 0.524                                                                                                                                                                                                                                                                                                                             |
| cos(a)                         | 1        | 1        | 0            | 0            | 取 a 弧度的余弦值 cos(1.5) 返回约 0.0707                                                                                                                                                                                                                                                                                                                              |
| cosh(a)                        | 1        | 1        | 0            | 0            | 取 a 的双曲余弦值 cosh(1.5) 返回约 2.352                                                                                                                                                                                                                                                                                                                               |
| acos(a)                        | 1        | 1        | 0            | 0            | 取 a 弧度的反余弦值 acos(0.5) 返回约 1.047                                                                                                                                                                                                                                                                                                                             |
| tan(a)                         | 1        | 1        | 0            | 0            | 取 a 弧度的正切值 tan(1.5) 返回约 14.101                                                                                                                                                                                                                                                                                                                               |
| tanh(a)                        | 1        | 1        | 0            | 0            | 取 a 的双曲正切值 tanh(1.5) 返回约 0.905                                                                                                                                                                                                                                                                                                                               |
| atan(a)                        | 1        | 1        | 0            | 0            | 取 a 弧度的反正切值 atan(0.3) 返回约 0.291                                                                                                                                                                                                                                                                                                                             |
| atan2(y,x)                     | 2        | 2        | 0            | 0            | 取 y/x 的反正切值，并根据象限进行修正 atan2(4,3) 返回约 0.927                                                                                                                                                                                                                                                                                                             |
| log(a)                         | 1        | 1        | 0            | 0            | 取以 10 为底的对数 log(100) 返回 2                                                                                                                                                                                                                                                                                                                                      |
| pow10(a)                       | 1        | 1        | 0            | 0            | 取以 10 为底，a 的指数幂 pow10(2) 返回 100                                                                                                                                                                                                                                                                                                                             |
| ln(a)                          | 1        | 1        | 0            | 0            | 取以 e 为底，a 的对数 ln(2.8) 返回约 1.030                                                                                                                                                                                                                                                                                                                             |
| exp(a)                         | 1        | 1        | 0            | 0            | 取 e 的 a 次方 exp(2) 返回约 7.389                                                                                                                                                                                                                                                                                                                                     |
| logn(a,b)                      | 2        | 2        | 0            | 0            | 取以 b 为底，a 的对数 logn(16,2) 返回 4                                                                                                                                                                                                                                                                                                                                |
| ceil(a)                        | 1        | 1        | 0            | 0            | 将数字 a 向上取整 ceil(3.2) 返回 4                                                                                                                                                                                                                                                                                                                                     |
| floor(a)                       | 1        | 1        | 0            | 0            | 将数字 a 向下取整 floor(3.2) 返回 3                                                                                                                                                                                                                                                                                                                                    |
| rand(&seed

#### ExprEval内部常量

ExprEval提供以下常量：

| 常量         | 数学表达式  | 值                    |
| ------------ | --------- | ---------------------- |
| M\_E         | e         | 2.7182818284590452354  |
| M\_LOG2E     | log2(e)   | 1.4426950408889634074  |
| M\_LOG10E    | log10(e)  | 0.43429448190325182765 |
| M\_LN2       | ln(2)     | 0.69314718055994530942 |
| M\_LN10      | ln(10)    | 2.30258509299404568402 |
| M\_PI        | π         | 3.14159265358979323846 |
| M\_PI\_2     | π/2       | 1.57079632679489661923 |
| M\_PI\_4     | π/4       | 0.78539816339744830962 |
| M\_1\_PI     | 1/π       | 0.31830988618379067154 |
| M\_2\_PI     | 2/π       | 0.63661977236758134308 |
| M\_1\_SQRTPI | 1/√(π)    | 0.56418958354776       |
| M\_2\_SQRTPI | 2/√(π)    | 1.12837916709551257390 |
| M\_SQRT2     | √(2)      | 1.41421356237309504880 |
| M\_1\_SQRT2  | 1/√(2)    | 0.70710678118654752440 |