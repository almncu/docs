# PHP示例 - 闹钟功能

## 简介

在这里，我将描述如何配置FreeSwitch以创建一个简单的闹钟功能GUI。通过使用一个网页浏览器，可以编程地安排闹钟功能。使用这种方法，可以在不需要在数据库中构建表的情况下安排来电，因为它是基于内置的调度API。

这个脚本的特殊之处在于使用了基于IVR的贪睡功能，允许用户选择希望贪睡多久。

在我编辑这个页面的同时，您可以在讨论论坛中看到我发的帖子：[\[1\]](http://www.richardsmrt.com/cgi-bin/phpBB3/viewtopic.php?f=7&t=18)

你需要准备的东西：- 运行PHP的Web服务器 - 在FS中启用入站事件套接字 - 在FS中启用JavaScript

首先，在你的PHP服务器上创建一个空白的文本文件，并将其命名为"wake\_up\_call\_set.php"。

将以下代码粘贴到文档中：

**wake\_up\_call\_set.php** 源代码

```php
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title></title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<meta name="keywords" content="">
<meta name="description" content="FreeSWITCH闹钟功能">

</head>
<body>

<font size="5">闹钟功能</font>      
<?php 

// 这个脚本由Richard Smrt (www.RichardSmrt.com)上传提供给FreeSwitch
// 要编辑此文件，只需更改主机（在本例中为sip.richardsmrt.com）以匹配您的FreeSwitch服务器IP地址或域名。
// 此处使用默认密码和端口
// php脚本底部的命令是您输入API命令的位置
// 请参阅www.guayal.com以获取使此脚本工作的原始代码。
```

```php
$password = "ClueCon";
$port = "8021";
$host = "sip.richardsmrt.com";

function event_socket_create($host, $port, $password) {
    $fp = fsockopen($host, $port, $errno, $errdesc) 
      or die("连接 $host 失败");
    socket_set_blocking($fp,false);
    
    if ($fp) {
        while (!feof($fp)) {
           $buffer = fgets($fp, 1024);
           usleep(100); // 允许等待回应
           if (trim($buffer) == "Content-Type: auth/request") {
              fputs($fp, "auth $password\n\n");
              break;
           }
        }
        return $fp;
    }
    else {
        return false;
    }           
}

function event_socket_request($fp, $cmd) {

    if ($fp) {    
        fputs($fp, $cmd."\n\n");    
        usleep(100); // 允许等待回应
        
        $response = "";
        $i = 0;
        $contentlength = 0;
        while (!feof($fp)) {
           $buffer = fgets($fp, 4096);
           if ($contentlength > 0) {
              $response .= $buffer;
           }
           
           if ($contentlength == 0) { // 如果 contentlength 已设置，则不再处理
               if (strlen(trim($buffer)) > 0) { // 仅在缓冲区有内容时运行
                   $temparray = split(":", trim($buffer));
                   if ($temparray[0] == "Content-Length") {
                      $contentlength = trim($temparray[1]);
                   }
               }
           }
           
           usleep(100); // 允许等待回应
           
           // 脚本超时时的可选项 // 不要让 while 循环无限执行
           if ($i > 10000) { break; } 
           
           if ($contentlength > 0) { // 是否设置了 contentlength
               // 如果已读取所有内容，则停止读取
               if (strlen($response) >= $contentlength) {  
                  break;
               }
           }
           $i++;
        }
        
        return $response;
    }
    else {
      echo "没有句柄";
    }
}
// 这是第一个调度 API 命令，用于为用户安排一个“起源”来与唤醒呼叫分机进行连线。
// 用户将在下面的表单框中输入信息。详见下方。
if (isset($_POST['timestamp1']) && isset($_POST['phone1']) && isset($_POST['phone2']))  
{  
       $timestamp1 = $_POST['timestamp1'];  
       $phone1 = $_POST['phone1'];  
       $phone2 = $_POST['phone2'];   
       
$fp = event_socket_create($host, $port, $password);
$cmd = "api sched_api " . $timestamp1 . " none originate {absolute_codec_string=PCMU,origination_caller_id_name=WakeUP,origination_caller_id_number=WakeUP}user/" . $phone1 . " " . $phone2; ；
$response = event_socket_request($fp, $cmd);
echo $response; 
fclose($fp);  
} 
```
在上面的 PHP 代码中，我们定义了一些函数和变量，以便进行与 SIP 服务器的连接和通信。如果用户在指定的表单框中输入了日期时间戳、电话号码等信息，则会触发一个调度 API 命令，将用户与唤醒呼叫分机进行连线。这个命令会通过与 SIP 服务器建立的连接发送，并返回相应的响应。

// 这是第二个调度API命令，用于将一个网关分机（比如手机号码）与闹钟分机连接起来。
// 用户将在下面的表单框中输入信息。请参考下面的内容。
if (isset($_POST['phone5']) && isset($_POST['phone6']))  
{  
    $timestamp1 = $_POST['timestamp1'];  
    $phone1 = $_POST['phone5'];  
    $phone2 = $_POST['phone6'];  
    
    $fp = event_socket_create($host, $port, $password);
    // "ignore_early_media=true" 将在 phone1 接听后连接到 phone2。
    $cmd = "api sched_api " . $timestamp1 . " none originate {ignore_early_media=true,absolute_codec_string=PCMU,origination_caller_id_name=sip.richardsmrt.com,origination_caller_id_number=15059089989}sofia/gateway/vitelity-outbound/" . $phone1 . " " . $phone2;  ;
    $response = event_socket_request($fp, $cmd);
    echo $response; 
    fclose($fp);  
} 
?>
<br>
在这里，您可以自动设置闹钟电话。
<table width="681" border="1">
    <tr>
    <!-- 这是第一个用户输入框，用于将一个网关分机（比如手机号码）与闹钟分机连接起来。 -->
    <!-- 注意 "phone1" 和 "phone2" 与上面的 php "$phone = $_POST" 函数匹配。 -->
    <!-- 为了使其正常工作，action="" 必须与包含此表单的 .php 文件的名称相匹配。例如，在本例中文件名为 "wake_up_call_set.php" -->
    <td width = "333" valign = "top">
    <form name = "schedule" action = "wake_up_call_set.php" method = "POST">  
        Call Extension:                   
        <input type = "text" name = "phone1" value = "1000"/>
        <br/>  
        Bridge with Extension:        
        <input type = "text" name = "phone2" value = "6980"/>
        <br/>   
        Enter Wakeup Timestamp: <input type = "text" name = "timestamp1" value = "" />
        <br/>  
        <input type = "submit" value = "Set Now!" >
        <br>
    </form>

</td>
<!-- 这是第一个用户输入框，用于连接用户和唤醒电话分机-->
<!-- 注意“phone1”和“phone2”与上面的PHP“$phone = $_POST”函数匹配-->
<td width="332" valign="top">
<form name="schedule" action="wake_up_call_set.php" method="POST">  
呼叫电话号码：           
<input type="text" name="phone5" value="15051112222" /><br/>  
与分机建立桥接：        
<input type="text" name="phone6" value="6980" /><br/>   
输入唤醒时间戳： <input type="text" name="timestamp1" value="" />
<br/>  
<input type="submit" value="立即设置" >
</form>
</td>
</tr>
<tr>
<td valign="top">
<font size="2">使用说明： 输入Unix时间戳（在下面计算），或者“+<时间>”表示执行命令前等待的秒数。示例：+10（等待10秒）</font>.
</td>
<td valign="top">
<font size="2">API代码示例：sched_api +12 none originate user/1001 6980</font><br>
<font size="2">在这里列出计划任务：<a href="http://sip.richardsmrt.com:8010/webapi/show?tasks">显示任务</a></font>
</p>
</td>
</tr>
</table>
<p> </p>
<p><font size="5">计算时间戳</font><br>
</p>
<!--调度API命令使用Unix时间戳，所以您可以在此将时间转换为Unix时间戳。请参阅下面的PHP函数-->
<!--这里我输入了一些示例值，以便更快地输入时间-->
<form name="form1" method="post" action="wake_up_call_set.php">
        <p> <font face="Courier New, Courier, mono"> 
日期：
<input name="y" type="text" id="y" size="4" maxlength="4" value="2010"> (y) /

```html
<select name="m" id="m">
  <option value="1">1</option>
  <option value="2">2</option>
  <option value="3">3</option>
  <option value="4">4</option>
  <option value="5">5</option>
  <option value="6">6</option>
  <option value="7">7</option>
  <option value="8" selected>8</option>
  <option value="9">9</option>
  <option value="10">10</option>
  <option value="11">11</option>
  <option value="12">12</option>
</select>
(m) /
```

```simplified-chinese
<select name="m" id="m">
  <option value="1">1</option>
  <option value="2">2</option>
  <option value="3">3</option>
  <option value="4">4</option>
  <option value="5">5</option>
  <option value="6">6</option>
  <option value="7">7</option>
  <option value="8" selected>8</option>
  <option value="9">9</option>
  <option value="10">10</option>
  <option value="11">11</option>
  <option value="12">12</option>
</select>
(m) /
```

```html
<select name="d" id="d">
   <option value="1" selected>1</option>
   <option value="2">2</option>
   ...
   <option value="30">30</option>
   <option value="31">31</option>
</select>
(d) @ 
<input name="hours" type="text" id="hours" size="2" maxlength="2" value="11">
:<input name="min" type="text" id="min" size="2" maxlength="2" value="30">
:<input name="sec" type="text" id="sec" value="0" size="2" maxlength="2">
(24h:min:sec) </font></p>
<input type="submit" name="Submit" value="      Convert      ">
</font> </p>
</form> 
<table width="681" border="1">
   <tr>
      <td width="333" valign="top"><strong> Unix Timestamp Output:</strong><br>
         <?php
         if (isset($_POST['m']) && isset($_POST['d']) && isset($_POST['y']) && isset($_POST['hours']) && isset($_POST['min']) && isset($_POST['sec']))  
         {  
            $m = $_POST['m'];  
            $d = $_POST['d'];   
            $y = $_POST['y'];  
            $hours = $_POST['hours'];  
            $min = $_POST['min'];
            $sec = $_POST['sec'];
         }  
         // mktime ( $hour, $minute, $second, $month, $day, $year, $is_dst );
         # $is_dst : 1 = daylight savings time (DST), 0 = no DST ,  -1 (default) = auto    
         echo mktime($hours,$min,$sec,$m,$d,$y); 
         ?>
      </td>
      <td width="332" valign="top">
         <p>
            <strong>Current time: </strong><br>
            <?php
            // Here you will print the current date and time. This will let you know what the php time is.
            echo date("m/d/y : H:i:s", time())
            ?>
            <br>
            <strong>Current unix Timestamp:</strong> <br>
            <?php
            // Here you will print the current unix timestamp.
            echo time();
            ?>
         </p>
      </td>
   </tr>
</table>
<p></p>
</body>
</html>
```

```html
<select name="d" id="d">
   <option value="1" selected>1</option>
   <option value="2">2</option>
   ...
   <option value="30">30</option>
   <option value="31">31</option>
</select>
(d) @ 
<input name="hours" type="text" id="hours" size="2" maxlength="2" value="11">
:<input name="min" type="text" id="min" size="2" maxlength="2" value="30">
:<input name="sec" type="text" id="sec" value="0" size="2" maxlength="2">
(24h:min:sec) </font></p>
<input type="submit" name="Submit" value="      Convert      ">
</font> </p>
</form> 
<table width="681" border="1">
   <tr>
      <td width="333" valign="top"><strong> Unix Timestamp Output:</strong><br>
         <?php
         if (isset($_POST['m']) && isset($_POST['d']) && isset($_POST['y']) && isset($_POST['hours']) && isset($_POST['min']) && isset($_POST['sec']))  
         {  
            $m = $_POST['m'];  
            $d = $_POST['d'];   
            $y = $_POST['y'];  
            $hours = $_POST['hours'];  
            $min = $_POST['min'];
            $sec = $_POST['sec'];
         }  
         // mktime ( $hour, $minute, $second, $month, $day, $year, $is_dst );
         # $is_dst : 1 = daylight savings time (DST), 0 = no DST ,  -1 (default) = auto    
         echo mktime($hours,$min,$sec,$m,$d,$y); 
         ?>
      </td>
      <td width="332" valign="top">
         <p>
            <strong>Current time: </strong><br>
            <?php
            // Here you will print the current date and time. This will let you know what the php time is.
            echo date("m/d/y : H:i:s", time())
            ?>
            <br>
            <strong>Current unix Timestamp:</strong> <br>
            <?php
            // Here you will print the current unix timestamp.
            echo time();
            ?>
         </p>
      </td>
   </tr>
</table>
<p></p>
</body>
</html>
```

然后，您必须决定用户在接到唤醒电话时会体验到什么。在此可选示例中，我们将创建一个IVR来为用户播放定制消息。此示例使用TTS，因此当唤醒电话接通时，您将听到“这是您的唤醒电话”。

以下是我的ivr.conf.xml文件的示例：

```xml
<menu name="Wakeup_IVR_1"
greet-long="say:您好，这是您的唤醒电话。
要延迟10分钟，请按1键。
要延迟20分钟，请按2键。
要延迟30分钟，请按3键。
要延迟60分钟，请按6键。
要重复此菜单，请按9键。"
greet-short="say:
要延迟10分钟，请按1键。
要延迟20分钟，请按2键。
要延迟30分钟，请按3键。
要延迟60分钟，请按6键。
要重复此菜单，请按9键。"
invalid-sound="ivr/ivr-that_was_an_invalid_entry.wav"
timeout="4000"
inter-digit-timeout="1000"
max-failures="3"
max-timeouts="3"
digit-len="4"
tts-engine="cepstral"
tts-voice="callie">
<entry action="menu-exec-app" digits="1" param="transfer snooze_10 XML default"/> 
<entry action="menu-exec-app" digits="2" param="transfer snooze_20 XML default"/> 
<entry action="menu-exec-app" digits="3" param="transfer snooze_30 XML default"/> 
<entry action="menu-exec-app" digits="6" param="transfer snooze_60 XML default"/> 
<entry action="menu-top" digits="9"/>
</menu>
```

注意：您会注意到有“延迟”命令。延迟命令是可选的，并将使用拨号计划。请参阅下面的最后一节以启用这些“延迟”场景。

接下来，您必须为唤醒电话创建一个拨号计划。在上述示例中，我使用分机号码“6980”来呼叫唤醒IVR。

```xml
<extension name="唤醒_IVR_1">
<condition field="destination_number" expression="^6980$">
<action application="set" data="transfer_ringback=$${hold_music}" />
<action application="answer" />
<action application="sleep" data="1000" />
<action application="ivr" data="唤醒_IVR_1" />
</condition>
</extension>
```

最后，如果你想创建一个"推迟响铃"按钮，请参考以下步骤。不要太沉迷于这些长长的"推迟响铃"功能。

1.) 在你的拨号计划中添加以下内容：

```xml
<extension name="唤醒电话推迟_10">
<condition field="destination_number" expression="^推迟_10$">
<action application="javascript" data="api_唤醒电话推迟_10.js" />
</condition>
</extension>
<extension name="唤醒电话推迟_20">
<condition field="destination_number" expression="^推迟_20$">
<action application="javascript" data="api_唤醒电话推迟_20.js" />
</condition>
</extension>
<extension name="唤醒电话推迟_30">
<condition field="destination_number" expression="^推迟_30$">
<action application="answer" />
<action application="javascript" data="api_唤醒电话推迟_30.js" />
</condition>
</extension>
<extension name="唤醒电话推迟_60">
<condition field="destination_number" expression="^推迟_60$">
<action application="answer" />
<action application="javascript" data="api_唤醒电话推迟_60.js" />
</condition>
</extension>
```

2.) 你需要手动创建上述拨号计划中提到的javascript文件。

例如，要创建一个10分钟的推迟响铃：在FS "scripts"目录下创建文件"api_唤醒电话推迟_10.js"，并将.js文件中包含以下apiExecute命令。

```xml
apiExecute("sched_api", "+600 none originate user/1000,user/1001 6980");
```