# Python_SBC

## 关于

由[Addison Martin](https://freeswitch.org/confluence/display/~nikko)撰写。本文档介绍了PySBC的相关信息。

点击此处展开目录

* 1 [PySBC: 使用Python编写的会话边界控制器](#pysbc-a-session-border-controller-in-python)  
   * 1.1 [我的计划](#my-plans)  
   * 1.2 [初始代码](#beginning-code)

## PySBC: 使用Python编写的会话边界控制器

FreeSWITCH并不是一个纯会话边界控制器（SBC）。要在FreeSWITCH集群中实现真正的可伸缩度、负载均衡和故障转移，您需要在FreeSWITCH媒体服务器前面使用一个轻量级、高性能的SBC集群来处理媒体代理。

### 我的计划

使用Python编写的SBC - 使用FreeSWITCH ESL库和Twisted，PySBC是一个使用Python编写的服务器，它使用ESL来跟踪每个服务器的呼叫量。然后，PySBC接收到的每个SIP请求，都会检查负载最低的服务器，并通过302重定向将请求发送到该服务器。

BAM! SBC

冗余性由2个服务器上的心跳处理

### 初始代码

```py
#注：这段代码是不完整的！它可以运行，但会产生运行时错误。
"""
PySBC.py  - Nik基于Python的用于FreeSWITCH的负载均衡SBC

版权所有（c）2010 Nik Martin, Server Corps LLC
保留所有权利。

在满足以下条件的情况下，允许以源代码和二进制形式再分发和使用，
无论是否进行修改：

```
源代码的再分发必须保留上述版权声明、条件列表和以下免责声明。
以二进制形式再分发时，必须在文档和/或其他提供的材料中复制上述版权声明、条件列表和以下免责声明。
未经事先书面许可，不得使用<ORGANIZATION>的名称或其贡献者的姓名来认可或推广从此软件衍生的产品。
此软件按原样提供，包括但不限于任何明示或暗示的保证，包括但不限于适销性和特定用途适用性的保证。
在任何情况下，版权所有者或贡献者都不对任何直接、间接、附带、特殊、惩罚性或后果性损害（包括但不限于替代货物或服务采购、使用、数据或利润的损失或业务中断）承担责任，无论是基于合同、严格责任还是侵权行为（包括疏忽或其他）的任何理论，即使已被告知存在这种可能性。
```

```python
import ConfigParser
import sys
from twisted.internet import reactor
from twisted.protocols import sip
from twisted.internet.protocol import ServerFactory

from ESL import ESLconnection

class SipProxy(sip.Proxy):
    """实际的代理SBC"""

    def __init__(self):
        """这段代码只是运行"""
        sip.Proxy.__init__(self, host=listenip, port=5060)

    def handle_request(self, message, addr):
        """代理所有请求，我们当前不关心它们是什么"""
```

```python

        print message.toString()
        print dir(message)
        if message.method == 'ACK':
            return
        # 现在，获取负载最小的服务器
        server = loadbalancer.getserver(fslist)
        
        response = self.responseFromRequest(302, message)
        response.addHeader("Contact", "sip:127.0.0.1:5060")
        response.creationFinished()
        self.deliverResponse(response)
        print response
        print addr


"""
class sipfactory(ServerFactory):

        protocol=SipProxy
"""

class loadbalancer:
    """FreeSWITCH 负载均衡器。
    当前使用 Current_Calls/Max_Calls=%load"""
    def getserver(fslist):
        """获取将下一步操作重定向到的最佳服务器"""
        try:
            for server in server_list(len(fslist)):
                con = ESLconnection(server, esl_port, esl_pass)

            # 是否已连接？
            if con.connected():
                # 执行命令
                e = con.api('show calls count')
                print e.getBody()

            else:
                print "未连接"
                sys.exit(2)

        except:
            print "连接服务器时出错" + server

class setup:
    """进行初始化的设置类"""
    config = ConfigParser.RawConfigParser()
    config.read('/etc/pysbc.cfg')
    myip = config.get('pysbc_config', 'listen_ip')
    server_list = config.get('freeswitch_config', 'server_list')
    server_list = server_list.split(",")
    esl_pass = config.get('freeswitch_config', 'esl_pass')
    esl_port = config.get('freeswitch_config', 'esl_port')


sconfig = setup()
listenip = sconfig.myip
fslist = sconfig.server_list
reactor.listenUDP(5060, SipProxy(), listenip)
reactor.run()
```