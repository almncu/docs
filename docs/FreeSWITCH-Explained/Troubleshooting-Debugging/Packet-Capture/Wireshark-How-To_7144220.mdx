# Wireshark 如何使用

## 关于

一些使用Wireshark查找SIP信令和RTP媒体流问题的提示。请注意，如果RTP流经过加密，则这些处理RTP流的技术不适用。

原网站已不再可用。

Archive.org版本：<http://web.archive.org/web/20101204200659/http://www.panoramisk.com/151/analyzing-voip-with-wireshark/en/>

点击这里展开目录

* 1 [使用Wireshark分析VoIP](#analyzing-voip-with-wireshark)
* 2 [介绍](#introduction)
* 3 [如何捕获帧](#how-to-capture-frames)
* 4 [使用tcpdump进行捕获](#capture-with-tcpdump)  
   * 4.1 [本地捕获](#local-capture)  
   * 4.2 [远程捕获](#remote-capture)
* 5 [分析](#analyze)  
   * 5.1 [过滤](#filtering)  
   * 5.2 [SIP分析](#sip-analysis)  
   * 5.3 [RTP分析](#rtp-analysis)  
   * 5.4 [解析tcpdump字段](#parsing-tcpdump-fields)
* 6 [总结](#conclusion)

## 使用Wireshark分析VoIP

在IP电话领域工作时，了解如何使用网络分析工具非常重要，以便了解流量在网络中的传播情况。本文介绍了一些与语音传输协议相关的Wireshark功能。

## 介绍

Wireshark（前身为Ethereal）是处理使用网络的应用程序时必备的工具。它简单高效，可以运行在Microsoft Windows或Linux上。而且它是免费的。尽管在一些商业产品上可能会找到功能非常强大的特性，但Wireshark有一些面向VoIP领域（以及其他领域）的良好插件。本文重点介绍了SIP和RTP协议，这是目前大部分使用的VoIP实现。

## 如何捕获帧

在分析网络中的网络帧之前，需要先捕获它们。分析可以实时进行，当Wireshark运行在探测器本身上时，也可以将网络帧捕获并存储在文件中，之后再进行分析。更重要的是确定探测器的位置，以便收集包含语音相关协议的适当网络帧。由于SIP协议的本质是分布式的，收集语音流量是一个挑战，但是存在解决方案。

为了收集语音帧，我们可以直接使用Wireshark或者使用大多数Unix系统上可用的应用程序tcpdump，在命令行直接运行。

使用选择的工具，有两种方法建议：

* **使用交换机上的镜像端口：** 这个解决方案需要使用具有端口镜像功能的网络交换机。这个功能通常在高级企业产品上可用，但一些低端设备不支持。这个功能有时被称为端口镜像或SPAN端口，但工作原理是相同的：我们配置交换机将特定端口传输的所有帧都复制到另一个专用端口，连接到该端口的是分析仪。如果语音流量与数据流量分离在特定的VLAN上，有时可以将通过该VLAN传输的所有流量复制到复制端口。我们将复制的端口是SIP代理所连接的端口，但如果我们更清楚地知道要查找的内容，也可以复制IP电话的端口。

* **直接使用代理服务器：** 这个第二个解决方案是关于在托管代理的Unix服务器上捕获流量。当然，这需要直接从该服务器运行tcpdump命令，而这并不总是可能的。在Asterisk的情况下，我们主要使用Linux作为主机系统，Linux在大多数发行版中都支持tcpdump，如果尚未安装，我们将直接从软件包中安装它。

## 使用tcpdump进行捕获

在使用Asterisk时，我们可以利用以下两个主要要点：

* 操作系统主要是Linux，因此我们可以使用tcpdump。
* Asterisk充当"back-to-back UA（背靠背用户代理）"，也就是说，它通常位于任何会话（电话呼叫）的中间，即使这并不遵循SIP的分布模型，我们将利用它。

直接从Asterisk服务器进行捕获时，我们将获得完整的语音会话，包括信令（SIP部分）和语音传输（RTP部分）。

tcpdump是一个字符模式命令，不需要任何图形界面来运行，非常轻便。我们可以在不给语音网关造成太大压力和影响质量的情况下使用它。与Unix一样，该命令需要参数，tcpdump提供了许多选项。以下是我们这种情况下有用的选项列表：

* \-p：不以混杂模式启动，只捕获到或从Asterisk节点发出的帧，
* \-n：不进行名称解析，否则我们会有很多不必要的DNS查询，在此阶段没有用处，如果需要，我们可以随后进行名称解析，
* \-s 0：获取完整的帧，而不仅仅是前几个字节。当仅在协议级别工作时，仅获取每个帧的开头就足够了，在我们的情况下，我们需要获取SIP和RTP帧的内容。0表示获取整个帧，
* \-w 输出文件：所有捕获到的帧将存储在该文件中。这样，我们随后就可以从文件中分析这些帧。如果将文件名指定为“-”，则输出将被发送到标准输出。

此外，我们可以指定一个过滤器给tcpdump，以降低捕获到的帧的数量。例如，我们只获取UDP帧并过滤IP地址，以便只关注特定的主机。

### 本地捕获

为了直接在Asterisk主机上执行捕获操作，我们应该与其连接。可以通过控制台直接连接或者通过远程终端实现。像许多管理员一样，我更喜欢使用ssh，因为它简单而安全。

使用以下命令：

  tcpdump -w trace.cap -p -n -s 0 "udp"

### 远程捕获

由于您可以管理多个Asterisk服务器，因此可以通过使用ssh提供的远程命令功能，从您的台式机开始捕获会更容易。台式机上需要安装ssh命令，macOS和Linux上已经安装了，您可以在Microsoft Windows上安装Cygwin版本，它将具有完全相同的命令。

建议的命令是：

  ssh root@asterisk 'tcpdump -w - -p -n -s 0 udp' > capture-asterisk.cap

捕获将在名为asterisk的服务器上使用tcpdump命令进行，帧将不会存储在服务器本身上，而是通过ssh隧道2重定向到台式机。文件将被命名为capture-asterisk.cap，并存储在您本地工作站的当前目录中。使用这种方法，您可以在多个Asterisk服务器上开始捕获，而无需连接到它们的控制台会话并在此之后传输捕获文件；此外，远程机器上没有存储问题。

## 分析

一旦我们有了跟踪文件，我们可以使用Wireshark工具进行深入分析。

Wireshark使用丰富的图形界面，并显示捕获的所有帧。在上窗口部分，您有帧列表，在下方是所选帧的内容，可以是解码或原始格式。Ethernet和IP协议已解码，我们今天关注的是SIP、IAX2和RTP协议，它们专门用于语音传输。

我们可以从文件浏览器中打开跟踪文件并进行分析。默认情况下，帧按照到达时间排序，如果需要，您可以更改此排序条件。

### 过滤

根据在捕获过程中使用的过滤器，我们可能会在其中有噪声帧。 Wireshark的过滤功能允许只关注特定的帧。它通过窗口上部的“Filter”对话框来激活。过滤语言是特定的但易于学习，例如，如果只需要SIP帧，则输入“sip”过滤器，如果对IAX感兴趣，则使用“iax2”过滤器。

当过滤字段的背景为绿色时，语法是正确的，当为橙色时，表示语法不正确。

如果您需要更复杂的过滤规则，可以直接从解码窗口中选择字段。每个协议字段都可以通过右键单击并选择“应用为过滤器”/…和“选中”菜单添加到当前过滤器中。

### SIP分析

在查看捕获到的所有帧时，很可能很难迅速找到我们想要的内容。幸运的是，Wireshark附带了一些SIP工具，可以通过“统计/ VoIP呼叫”菜单进行访问。

在窗口中，您将看到捕获文件中的所有VoIP呼叫。如果使用Wireshark直接进行捕获，则此列表将实时更新。

从列表中，可以以图形方式显示特定的对话。这个视图对于跟踪对话非常有帮助，因为可以在主窗口中选择和检查所有帧。还可以分析语音对话的内容，因为它是在RTP文件中传输的。

“播放器”功能解码与所选对话关联的RTP帧。图表显示了双向语音流的形状。这个工具在关注语音质量时很有趣，如果用户在与特定电话通话时抱怨，可以之后听取对话。

### RTP分析

RTP4协议并不专门用于语音IP流量。但是在H.323和SIP信令旁边使用此协议，Wireshark提供了一个特定模块来分析RTP流。可以通过“统计信息/RTP/流分析”菜单找到该功能。

分析窗口提供了有关参与对话的终端、使用的编解码器以及有关流的一些统计信息。您可以关注抖动和丢包等问题，以了解为什么语音质量不够好。从此模块，还可以提取RTP帧的内容并重新构建语音声音文件。该文件将以WAV格式保存，您可以使用任何可用的音频播放器进行听取。

### 解析tcpdump字段

由FreeSWITCH Slack频道上的David Witham提供：

如果您想要在tcpdump或sngrep的输出中打印特定字段，awk是一个有用的工具。如果我有一个示例输出的文件，内容如下：

**tcpdump的示例输出**

```bash
$ cat tcpdump.txt
10:39:30.860838 IP 172.27.228.145.5060 > 172.27.107.222.59716: SIP: SIP/2.0 200 OK
10:39:32.530710 IP 172.27.228.145.5060 > 172.27.107.222.59716: SIP: SIP/2.0 200 OK
10:40:08.825797 IP 172.27.228.145.5060 > 172.27.107.222.61681: SIP: SIP/2.0 200 OK
```

然后使用grep过滤选择所需行，然后通过awk打印所需字段。例如，源IP和SIP消息：

**awk字段选择**

```bash
$ cat tcpdump.txt | egrep "200 OK|403" | awk '{print $3 " " $8}'
172.27.228.145.5060 200
172.27.228.145.5060 200
172.27.228.145.5060 200
```

如果你想从IP地址中删除端口号，可以使用"."（点）作为分隔符将字段拆分成一个数组"a"，然后打印前4个元素，用一个字面的"."（点）分开。

**使用awk数组删除端口号**

```bash
$ cat tcpdump.txt | egrep "200 OK|403" | awk '{split($3,a,"."); print a[1]"."a[2]"."a[3]"."a[4] " " $8}'
172.27.228.145 200
172.27.228.145 200
172.27.228.145 200
```

注意：我在awk脚本中使用了单引号，这样我就可以在其中使用双引号。或者您可以将更复杂的awk脚本放入一个文件中，并使用-f选项。希望这有所帮助。

## 结论

IP电话，像任何严重依赖网络的应用程序一样，在发生问题时应进行分析。为了做出反应，我的建议是在一切正常，你有空闲时间进行培训。这将使您熟悉工具，同时即使在没有发现特别问题的情况下，在网络上发现问题也是非常常见的。最后，不要害怕协议，即使它们很复杂。正确理解它们将在您处理系统上的实际问题时带来很大优势。